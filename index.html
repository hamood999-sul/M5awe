<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø¯Ø±Ø¨ÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ - Ù†Ø³Ø®Ø© Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f4f8; touch-action: manipulation; }
        .card { background: white; border-radius: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
        #scanner-wrap { 
            width: 100%; max-width: 400px; margin: 0 auto; overflow: hidden; 
            border-radius: 20px; border: 4px solid #3b82f6; height: 220px; 
            position: relative; background: #000; 
        }
        #interactive video { width: 100%; height: 100%; object-fit: cover; }
        .laser {
            position: absolute; top: 50%; left: 0; right: 0; height: 2px;
            background: rgba(255, 0, 0, 0.5); box-shadow: 0 0 10px red;
            animation: scanning 2s infinite; z-index: 10;
        }
        @keyframes scanning { 0%, 100% { top: 25%; } 50% { top: 75%; } }
        .pill-tag { background: #e0f2fe; color: #0369a1; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: bold; }
    </style>
</head>
<body class="p-4 pb-24">

    <div class="card p-6 mb-4 border-t-8 border-blue-600">
        <div class="flex justify-between items-center mb-4">
            <input type="date" id="date-picker" onchange="changeDate()" class="bg-gray-100 rounded-lg px-2 py-1 text-xs font-bold outline-none">
            <button onclick="editGoals()" class="text-xs bg-blue-50 text-blue-600 px-3 py-1 rounded-full font-bold">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù âš™ï¸</button>
        </div>
        <div class="text-center mb-4">
            <div id="cal-container" class="text-5xl font-black text-slate-800 transition-all">
                <span id="total-calories">0</span>
            </div>
            <div class="text-[10px] text-gray-400 mt-1 uppercase">Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ©</div>
        </div>
        <div class="flex gap-2 text-center">
            <div class="flex-1 bg-orange-50 p-2 rounded-xl border border-orange-100">
                <small class="block text-[9px] text-orange-400 font-bold">Ø¨Ø±ÙˆØªÙŠÙ†</small><b id="total-protein">0</b>g
            </div>
            <div class="flex-1 bg-blue-50 p-2 rounded-xl border border-blue-100">
                <small class="block text-[9px] text-blue-400 font-bold">ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª</small><b id="total-carbs">0</b>g
            </div>
            <div class="flex-1 bg-yellow-50 p-2 rounded-xl border border-yellow-100">
                <small class="block text-[9px] text-yellow-600 font-bold">Ø¯Ù‡ÙˆÙ†</small><b id="total-fat">0</b>g
            </div>
        </div>
    </div>

    <div id="scanner-section" class="hidden mb-4">
        <div id="scanner-wrap">
            <div id="interactive" class="viewport"></div>
            <div class="laser"></div>
            <button onclick="stopScanner()" class="absolute top-2 right-2 bg-red-500 text-white w-8 h-8 rounded-full font-bold z-[60]">âœ•</button>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-4 mb-6">
        <button onclick="startScanner()" class="card p-4 bg-slate-900 text-white font-bold flex flex-col items-center">
            <span class="text-xl">ğŸ“·</span><span class="text-xs mt-1 font-bold">Ø³ÙƒØ§Ù† Ø¨Ø§Ø±ÙƒÙˆØ¯</span>
        </button>
        <div class="grid grid-rows-2 gap-2">
            <button onclick="showManualAdd()" class="card p-2 bg-white border-2 border-slate-900 font-bold text-[10px]">â• Ø¥Ø¶Ø§ÙØ© ÙˆØ¬Ø¨Ø©</button>
            <button onclick="addSupp()" class="card p-2 bg-blue-600 text-white font-bold text-[10px]">ğŸ’Š Ø¥Ø¶Ø§ÙØ© Ø­Ø¨ÙˆØ¨</button>
        </div>
    </div>

    <div class="card p-5 mb-4">
        <h2 class="font-bold text-slate-700 mb-3 text-sm border-b pb-1">Ø³Ø¬Ù„ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</h2>
        <ul id="meals-list" class="space-y-2"></ul>
    </div>

    <div class="card p-5 min-h-[100px] border-l-8 border-blue-400">
        <div class="flex justify-between items-center mb-3 border-b pb-1">
            <h2 class="font-bold text-slate-700 text-sm italic">ğŸ’Š Ø§Ù„Ù…ÙƒÙ…Ù„Ø§Øª ÙˆØ§Ù„Ø­Ø¨ÙˆØ¨</h2>
        </div>
        <ul id="supps-list" class="space-y-2 text-sm"></ul>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-slate-900/95 backdrop-blur-md flex items-center justify-center p-6 z-[100]">
        <div class="bg-white p-7 rounded-[35px] w-full max-w-sm text-center">
            <h3 id="p-name" class="font-black text-lg mb-4 text-slate-800">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</h3>
            <div id="macro-preview" class="grid grid-cols-2 gap-2 mb-6">
                <div class="bg-gray-50 p-2 rounded-xl"><small class="block text-[9px]">Cal/100</small><b id="p-cal">0</b></div>
                <div class="bg-orange-50 p-2 rounded-xl"><small class="block text-[9px]">Protein</small><b id="p-prot">0</b></div>
            </div>
            <label class="block mb-2 text-xs font-bold text-gray-400">Ø§Ù„ÙƒÙ…ÙŠØ© Ø¨Ù€ (<span id="unit-label">ØºØ±Ø§Ù…</span>):</label>
            <input type="number" id="amount-input" class="w-full border-2 border-slate-100 p-4 rounded-2xl mb-6 text-center text-3xl outline-none" placeholder="0">
            <button onclick="saveMeal()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black text-lg shadow-lg">ØªØ£ÙƒÙŠØ¯</button>
            <button onclick="closeModal()" class="w-full text-slate-400 mt-4 text-sm font-bold">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <script>
        let allData = JSON.parse(localStorage.getItem('gymApp_Data')) || {};
        let suppsData = JSON.parse(localStorage.getItem('gymApp_Supps')) || {};
        let goals = JSON.parse(localStorage.getItem('gymApp_Goals')) || { cal: 2500, prot: 150 };
        let currentSelectedDate = new Date().toISOString().split('T')[0];
        let tempProd = { unit: 'ØºØ±Ø§Ù…', isSupp: false };

        document.getElementById('date-picker').value = currentSelectedDate;

        function startScanner() {
            document.getElementById('scanner-section').classList.remove('hidden');
            Quagga.init({
                inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#interactive'), constraints: { width: 1280, height: 720, facingMode: "environment", aspectRatio: 1.77 } },
                decoder: { readers: ["ean_reader", "ean_8_reader"] }, locate: true
            }, (err) => { if(!err) { Quagga.start(); setTimeout(applyCameraLocks, 1000); } });
            Quagga.onDetected(d => { fetchProductInfo(d.codeResult.code); });
        }

        async function applyCameraLocks() {
            const track = Quagga.CameraAccess.getActiveTrack();
            if (track && track.getCapabilities()?.zoom) track.applyConstraints({ advanced: [{ zoom: 2.0 }] });
        }

        function fetchProductInfo(code) {
            stopScanner(); showModal("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...");
            fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`)
                .then(r => r.json()).then(d => {
                    if(d.status === 1) {
                        let p = d.product;
                        let n = p.nutriments;
                        let unit = (p.product_name_de || "").toLowerCase().includes('wasser') ? 'Ù…Ù„Ù„ØªØ±' : 'ØºØ±Ø§Ù…';
                        tempProd = { name: p.product_name_de || p.product_name, cal100: n['energy-kcal_100g'] || 0, prot100: n['proteins_100g'] || 0, unit: unit, isSupp: false };
                        document.getElementById('p-name').innerText = tempProd.name;
                        document.getElementById('unit-label').innerText = unit;
                    } else { alert("ØºÙŠØ± Ù…Ø³Ø¬Ù„"); closeModal(); }
                });
        }

        function addSupp() {
            let n = prompt("Ø§Ø³Ù… Ø§Ù„Ø­Ø¨ÙˆØ¨ (Ù…Ø«Ù„Ø§Ù‹: ÙÙŠØªØ§Ù…ÙŠÙ† Ø³ÙŠ):");
            if(n) {
                tempProd = { name: n, isSupp: true, unit: 'Ø­Ø¨Ø©' };
                document.getElementById('macro-preview').classList.add('hidden');
                document.getElementById('p-name').innerText = n;
                document.getElementById('unit-label').innerText = 'Ø­Ø¨Ø©';
                showModal();
            }
        }

        function saveMeal() {
            let val = document.getElementById('amount-input').value;
            if(!val) return;
            if(tempProd.isSupp) {
                if(!suppsData[currentSelectedDate]) suppsData[currentSelectedDate] = [];
                suppsData[currentSelectedDate].push({ name: tempProd.name, count: val });
                localStorage.setItem('gymApp_Supps', JSON.stringify(suppsData));
            } else {
                if(!allData[currentSelectedDate]) allData[currentSelectedDate] = [];
                allData[currentSelectedDate].push({ name: tempProd.name, amount: val, unit: tempProd.unit, cal: (tempProd.cal100 * val)/100, prot: (tempProd.prot100 * val)/100 });
                localStorage.setItem('gymApp_Data', JSON.stringify(allData));
            }
            closeModal(); updateUI();
        }

        function updateUI() {
            const list = document.getElementById('meals-list');
            const sList = document.getElementById('supps-list');
            list.innerHTML = ''; sList.innerHTML = '';
            
            let meals = allData[currentSelectedDate] || [];
            let totals = { cal: 0, prot: 0 };
            meals.forEach((m, i) => {
                totals.cal += m.cal; totals.prot += m.prot;
                list.innerHTML += `<li class="flex justify-between text-xs p-2 bg-gray-50 rounded-lg"><span>${m.name}</span><b>${Math.round(m.cal)} Cal <button onclick="deleteItem(${i},'meal')" class="ml-2 text-red-300">âœ•</button></b></li>`;
            });

            let supps = suppsData[currentSelectedDate] || [];
            supps.forEach((s, i) => {
                sList.innerHTML += `<li class="flex justify-between items-center bg-blue-50 p-2 rounded-lg"><span>ğŸ’Š ${s.name}</span><span class="pill-tag">${s.count} Ø­Ø¨Ø© <button onclick="deleteItem(${i},'supp')" class="ml-2 text-red-400">âœ•</button></span></li>`;
            });

            document.getElementById('total-calories').innerText = Math.round(totals.cal);
            document.getElementById('total-protein').innerText = Math.round(totals.prot);
        }

        function deleteItem(i, type) {
            if(type === 'meal') allData[currentSelectedDate].splice(i, 1);
            else suppsData[currentSelectedDate].splice(i, 1);
            localStorage.setItem('gymApp_Data', JSON.stringify(allData));
            localStorage.setItem('gymApp_Supps', JSON.stringify(suppsData));
            updateUI();
        }

        function stopScanner() { Quagga.stop(); document.getElementById('scanner-section').classList.add('hidden'); }
        function showModal() { document.getElementById('modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); document.getElementById('macro-preview').classList.remove('hidden'); }
        function changeDate() { currentSelectedDate = document.getElementById('date-picker').value; updateUI(); }
        function clearDay() { if(confirm("Ù…Ø³Ø­ Ø§Ù„ÙŠÙˆÙ…ØŸ")) { allData[currentSelectedDate] = []; suppsData[currentSelectedDate] = []; updateUI(); } }
        function showManualAdd() { let n = prompt("Ø§Ù„Ø§Ø³Ù…:"); let c = prompt("Ø³Ø¹Ø±Ø§Øª/100:"); if(n && c) { tempProd = {name:n, cal100:c, unit:'ØºØ±Ø§Ù…', isSupp:false}; showModal(); } }
        function editGoals() { let c = prompt("Ø§Ù„Ù‡Ø¯Ù:", goals.cal); if(c) goals.cal = c; updateUI(); }

        updateUI();
    </script>
</body>
</html>
