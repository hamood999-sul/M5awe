<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø¯Ø±Ø¨ÙŠ Ø§Ù„Ø°ÙƒÙŠ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; overflow-x: hidden; }
        .card { background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        #scanner-wrap { width: 100%; max-width: 400px; margin: 0 auto; overflow: hidden; border-radius: 20px; border: 4px solid #10b981; position: relative; height: 200px; background: #000; }
        #interactive video { width: 100%; height: 100%; object-fit: cover; }
        .over-goal { color: #ef4444 !important; transform: scale(1.1); transition: all 0.3s; }
    </style>
</head>
<body class="p-4 pb-10">

    <div class="card p-6 mb-4 text-center border-t-8 border-green-500 relative">
        <input type="date" id="date-picker" onchange="changeDate()" class="mb-3 border-none bg-gray-100 rounded-full px-4 py-1 text-xs font-bold text-gray-600 outline-none">
        
        <div class="flex flex-col items-center">
            <span class="text-gray-400 text-xs mb-1">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</span>
            <div id="calorie-container" class="text-5xl font-black text-green-600 mb-1">
                <span id="total-calories">0</span>
            </div>
            
            <button onclick="editGoal()" class="flex items-center gap-1 bg-gray-50 px-3 py-1 rounded-full border border-gray-100 hover:bg-gray-100 transition-colors">
                <span class="text-[10px] text-gray-500 font-medium text-right">Ø§Ù„Ù‡Ø¯Ù: <span id="goal-display">2500</span></span>
                <span class="text-xs">âš™ï¸</span>
            </button>
        </div>
    </div>

    <div id="scanner-section" class="hidden mb-4 animate-in fade-in duration-300">
        <div id="scanner-wrap">
            <div id="interactive" class="viewport"></div>
            <button onclick="stopScanner()" class="absolute top-2 right-2 bg-red-500 text-white w-8 h-8 rounded-full shadow-lg font-bold z-50">âœ•</button>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-4 mb-6">
        <button onclick="startScanner()" class="card p-4 bg-zinc-900 text-white font-bold flex flex-col items-center active:scale-95 transition-transform">
            <span class="text-xl">ğŸ“·</span>
            <span class="text-xs mt-1 text-green-400">Barcode Scan</span>
        </button>
        <button onclick="showManualAdd()" class="card p-4 bg-white text-zinc-900 border-2 border-zinc-900 font-bold flex flex-col items-center active:scale-95 transition-transform">
            <span class="text-xl">â•</span>
            <span class="text-xs mt-1">Ø¥Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠØ©</span>
        </button>
    </div>

    <div class="card p-5 min-h-[250px]">
        <h2 class="font-bold text-gray-800 mb-4 border-b pb-2 flex justify-between items-center">
            <span>ÙˆØ¬Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</span>
            <button onclick="clearDay()" class="text-[10px] text-red-400 font-normal">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
        </h2>
        <ul id="meals-list" class="space-y-3"></ul>
        <div id="empty-state" class="text-center py-10 text-gray-300 text-sm hidden">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ¬Ø¨Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…</div>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-[100]">
        <div class="bg-white p-8 rounded-[30px] w-full max-w-sm shadow-2xl">
            <h3 id="product-name" class="font-black text-xl mb-2 text-zinc-800 leading-tight text-center">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</h3>
            <div class="bg-green-50 p-4 rounded-2xl mb-6 text-center border border-green-100">
                <span class="text-green-600 text-xs font-bold block mb-1 uppercase">Calories / 100g</span>
                <span id="cal-per-100" class="text-3xl font-black text-green-700">0</span>
            </div>
            
            <label class="block mb-2 text-xs font-bold text-gray-400 text-center">ÙƒÙ… ØºØ±Ø§Ù… ØªÙ†Ø§ÙˆÙ„ØªØŸ</label>
            <input type="number" id="amount-input" class="w-full border-2 border-gray-100 p-4 rounded-2xl mb-6 text-center text-2xl focus:border-green-500 focus:outline-none bg-gray-50" placeholder="0">
            
            <button onclick="addMealToLog()" class="w-full bg-green-500 text-white py-4 rounded-2xl font-black text-lg shadow-lg shadow-green-200 active:scale-95 transition-transform">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©</button>
            <button onclick="closeModal()" class="w-full text-gray-400 mt-4 text-sm font-medium">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <script>
        // Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
        let allData = JSON.parse(localStorage.getItem('calorieTrackerData')) || {};
        let myGoal = localStorage.getItem('myDailyGoal') || 2500;
        let currentSelectedDate = new Date().toISOString().split('T')[0];
        let currentProduct = { name: '', calories: 0 };

        document.getElementById('date-picker').value = currentSelectedDate;
        document.getElementById('goal-display').innerText = myGoal;

        function updateUI() {
            const list = document.getElementById('meals-list');
            const totalDisplay = document.getElementById('total-calories');
            const emptyState = document.getElementById('empty-state');
            const calContainer = document.getElementById('calorie-container');
            
            list.innerHTML = '';
            let total = 0;
            let dayMeals = allData[currentSelectedDate] || [];

            if(dayMeals.length === 0) emptyState.classList.remove('hidden');
            else emptyState.classList.add('hidden');

            dayMeals.forEach((meal, index) => {
                total += meal.totalCal;
                list.innerHTML += `
                    <li class="flex justify-between items-center p-3 bg-white border border-gray-100 rounded-xl shadow-sm">
                        <div class="flex flex-col">
                            <span class="font-bold text-sm text-gray-800">${meal.name}</span>
                            <span class="text-[10px] text-gray-400">${meal.amount} ØºØ±Ø§Ù…</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-black text-green-600">${Math.round(meal.totalCal)}</span>
                            <button onclick="deleteMeal(${index})" class="text-gray-300 hover:text-red-400">âœ•</button>
                        </div>
                    </li>`;
            });

            totalDisplay.innerText = Math.round(total);
            
            // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù‡Ø¯Ù ÙˆØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ†
            if(total > myGoal) {
                calContainer.classList.add('over-goal');
            } else {
                calContainer.classList.remove('over-goal');
            }

            localStorage.setItem('calorieTrackerData', JSON.stringify(allData));
        }

        function editGoal() {
            let newGoal = prompt("Ø£Ø¯Ø®Ù„ Ù‡Ø¯Ù Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯:", myGoal);
            if(newGoal && !isNaN(newGoal)) {
                myGoal = newGoal;
                localStorage.setItem('myDailyGoal', myGoal);
                document.getElementById('goal-display').innerText = myGoal;
                updateUI();
            }
        }

        function startScanner() {
            document.getElementById('scanner-section').classList.remove('hidden');
            Quagga.init({
                inputStream: { 
                    name: "Live", type: "LiveStream", target: document.querySelector('#interactive'),
                    constraints: { width: 400, height: 200, facingMode: "environment" } 
                },
                decoder: { readers: ["ean_reader", "ean_8_reader"] }
            }, (err) => { if(!err) Quagga.start(); });

            Quagga.onDetected((data) => {
                if(navigator.vibrate) navigator.vibrate(100);
                fetchProductInfo(data.codeResult.code);
            });
        }

        function fetchProductInfo(code) {
            stopScanner();
            showModal("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...");
            fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`)
                .then(res => res.json())
                .then(data => {
                    if(data.status === 1) {
                        let p = data.product;
                        currentProduct = {
                            name: p.product_name_de || p.product_name || "Ù…Ù†ØªØ¬ " + code,
                            calories: p.nutriments['energy-kcal_100g'] || 0
                        };
                        document.getElementById('product-name').innerText = currentProduct.name;
                        document.getElementById('cal-per-100').innerText = currentProduct.calories;
                    } else {
                        document.getElementById('product-name').innerText = "ØºÙŠØ± Ù…Ø³Ø¬Ù„: " + code;
                        document.getElementById('cal-per-100').innerText = "0";
                    }
                });
        }

        function addMealToLog() {
            const amount = document.getElementById('amount-input').value;
            if(!amount) return;
            const totalCal = (currentProduct.calories * amount) / 100;
            if(!allData[currentSelectedDate]) allData[currentSelectedDate] = [];
            allData[currentSelectedDate].push({ name: currentProduct.name, amount: amount, totalCal: totalCal });
            closeModal();
            updateUI();
        }

        function deleteMeal(index) {
            allData[currentSelectedDate].splice(index, 1);
            updateUI();
        }

        function stopScanner() { Quagga.stop(); document.getElementById('scanner-section').classList.add('hidden'); }
        function showModal(msg) { if(msg) document.getElementById('product-name').innerText = msg; document.getElementById('modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); document.getElementById('amount-input').value = ''; }
        function changeDate() { currentSelectedDate = document.getElementById('date-picker').value; updateUI(); }
        function showManualAdd() {
            let n = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:");
            let c = prompt("Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ù„ÙƒÙ„ 100 ØºØ±Ø§Ù…:");
            if(n && c) { currentProduct = { name: n, calories: parseFloat(c) }; showModal(); }
        }
        function clearDay() { if(confirm("Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ ÙˆØ¬Ø¨Ø§Øª Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…ØŸ")) { allData[currentSelectedDate] = []; updateUI(); } }

        updateUI();
    </script>
</body>
</html>
