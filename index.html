<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุฏุฑุจู ุงูุฑูุงุถู - ุงููุณุฎุฉ ุงููุตุญุญุฉ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; touch-action: manipulation; }
        .card { background: white; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #interactive video, #interactive canvas { width: 100%; height: auto; border-radius: 10px; }
        /* ุญู ูุดููุฉ ุงูุชุฏุงุฎู */
        #modal { z-index: 9999; } 
    </style>
</head>
<body class="p-4">

    <div class="card p-6 mb-4 text-center border-t-4 border-blue-500">
        <h1 class="text-2xl font-bold text-gray-800">ุณุฌู ุณุนุฑุงุชู ุงููููู ๐</h1>
        <p id="date-display" class="text-gray-500 mt-2"></p>
        <div class="mt-4 text-3xl font-extrabold text-blue-600">
            <span id="total-calories">0</span> <span class="text-sm text-gray-400 font-normal">ุณุนุฑุฉ</span>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-4 mb-4">
        <button onclick="startScanner()" class="card p-4 bg-green-500 text-white font-bold flex flex-col items-center shadow-lg active:scale-95 transition-transform">
            <span>๐ท ูุณุญ ุจุงุฑููุฏ</span>
        </button>
        <button onclick="showManualAdd()" class="card p-4 bg-blue-500 text-white font-bold flex flex-col items-center shadow-lg active:scale-95 transition-transform">
            <span>โ ุฅุถุงูุฉ ูุฏููุฉ</span>
        </button>
    </div>

    <div id="scanner-wrap" class="hidden mb-4">
        <div class="card p-2 bg-black relative">
            <div id="interactive" class="viewport"></div>
            <button onclick="stopScanner()" class="absolute top-2 right-2 bg-red-600 text-white px-3 py-1 rounded-full font-bold">ุฅุบูุงู X</button>
        </div>
        <p class="text-center text-sm mt-2 text-gray-500">ุถุน ุงูุจุงุฑููุฏ ูู ููุชุตู ุงููุฑุจุน</p>
    </div>

    <div class="card p-4">
        <h2 class="font-bold mb-4 border-b pb-2">ูุฌุจุงุช ุงูููู:</h2>
        <ul id="meals-list" class="space-y-3"></ul>
        <button onclick="clearAll()" class="mt-6 text-xs text-red-400 underline w-full text-center">ูุณุญ ุณุฌู ุงูููู</button>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center p-6">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm">
            <h3 id="product-name" class="font-bold text-xl mb-2 text-blue-600">ุฌุงุฑู ุงูุชุญููู...</h3>
            <p class="text-gray-500 mb-4">ุงูุณุนุฑุงุช (ููู 100 ุฌุฑุงู): <span id="cal-per-100" class="font-bold text-black">0</span></p>
            
            <label class="block mb-2 font-bold">ุงููููุฉ ุงูุชู ุชูุงููุชูุง (ุบุฑุงู):</label>
            <input type="number" id="amount-input" autofocus class="w-full border-2 border-blue-100 p-3 rounded-lg mb-4 text-center text-xl" placeholder="ูุซูุงู 150">
            
            <div class="flex gap-3">
                <button onclick="addMealToLog()" class="bg-green-500 text-white flex-[2] p-3 rounded-lg font-bold text-lg">ุฅุถุงูุฉ ููุณุฌู</button>
                <button onclick="closeModal()" class="bg-gray-200 text-gray-700 flex-1 p-3 rounded-lg">ุฅูุบุงุก</button>
            </div>
        </div>
    </div>

    <script>
        let currentProduct = { name: '', calories: 0 };
        let meals = JSON.parse(localStorage.getItem('myMeals')) || [];

        document.getElementById('date-display').innerText = new Date().toLocaleDateString('ar-EG', { weekday: 'long', day: 'numeric', month: 'long' });

        function updateUI() {
            const list = document.getElementById('meals-list');
            const totalDisplay = document.getElementById('total-calories');
            list.innerHTML = '';
            let total = 0;

            meals.forEach((meal, index) => {
                total += meal.totalCal;
                list.innerHTML += `
                    <li class="flex justify-between items-center bg-gray-50 p-4 rounded-xl border-r-4 border-blue-500 animate-in fade-in">
                        <div>
                            <div class="font-bold text-gray-800">${meal.name}</div>
                            <div class="text-xs text-gray-500">${meal.amount} ุบุฑุงู</div>
                        </div>
                        <div class="text-left font-bold text-blue-600">${Math.round(meal.totalCal)} ุณุนุฑุฉ</div>
                    </li>`;
            });
            totalDisplay.innerText = Math.round(total);
            localStorage.setItem('myMeals', JSON.stringify(meals));
        }

        function fetchProductInfo(code) {
            stopScanner(); // ุฅููุงู ุงููุงููุฑุง ููุฑุงู ุนูุฏ ุงูุนุซูุฑ ุนูู ููุฏ
            showModal("ุฌุงุฑู ุงูุจุญุซ...");
            
            fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`)
                .then(res => res.json())
                .then(data => {
                    if(data.status === 1) {
                        currentProduct = {
                            name: data.product.product_name || "ููุชุฌ ุบูุฑ ูุนุฑูู",
                            calories: data.product.nutriments['energy-kcal_100g'] || 0
                        };
                        document.getElementById('product-name').innerText = currentProduct.name;
                        document.getElementById('cal-per-100').innerText = currentProduct.calories;
                    } else {
                        alert("ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููุชุฌ. ุญุงูู ุงูุฅุถุงูุฉ ุงููุฏููุฉ.");
                        closeModal();
                    }
                }).catch(() => { alert("ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช"); closeModal(); });
        }

        function showModal(msg = "") {
            if(msg) document.getElementById('product-name').innerText = msg;
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('amount-input').value = '';
        }

        function showManualAdd() {
            currentProduct = { name: prompt("ุงุณู ุงููุฌุจุฉ/ุงูููุชุฌ:") || "ูุฌุจุฉ ูุฏููุฉ", calories: prompt("ุงูุณุนุฑุงุช ููู 100 ุบุฑุงู:") || 0 };
            if(currentProduct.name) showModal();
        }

        function addMealToLog() {
            const amount = document.getElementById('amount-input').value;
            if(!amount) return;
            const totalCal = (currentProduct.calories * amount) / 100;
            meals.push({ name: currentProduct.name, amount: amount, totalCal: totalCal });
            closeModal();
            updateUI();
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        function startScanner() {
            document.getElementById('scanner-wrap').classList.remove('hidden');
            Quagga.init({
                inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#interactive'), constraints: { facingMode: "environment" } },
                decoder: { readers: ["ean_reader", "ean_8_reader"] }
            }, (err) => {
                if (err) { alert("ุฎุทุฃ ูู ุชุดุบูู ุงููุงููุฑุง"); return; }
                Quagga.start();
            });

            Quagga.onDetected((data) => {
                // ุชูุนูู ุงูุชุฒุงุฒ ุจุณูุท ุนูุฏ ุงููุฌุงุญ (ุฅุฐุง ูุฏุนู ุงููุชุตูุญ)
                if(navigator.vibrate) navigator.vibrate(100);
                fetchProductInfo(data.codeResult.code);
            });
        }

        function stopScanner() {
            Quagga.stop();
            document.getElementById('scanner-wrap').classList.add('hidden');
        }

        function clearAll() { if(confirm("ูู ุชุฑูุฏ ูุณุญ ุฌููุน ูุฌุจุงุช ุงููููุ")) { meals = []; updateUI(); } }

        updateUI();
    </script>
</body>
</html>
