<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙÙƒØ±Ø© Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø³Ù†ÙˆÙŠØ©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); }
        #interactive video, #interactive canvas { width: 100%; height: auto; border-radius: 15px; }
        input[type="date"]::-webkit-calendar-picker-indicator { cursor: pointer; }
    </style>
</head>
<body class="p-4 pb-20">

    <div class="card p-6 mb-4 border-b-4 border-green-500">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-bold text-gray-800">ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø³Ø¹Ø±Ø§Øª ğŸ—“ï¸</h1>
            <input type="date" id="date-picker" onchange="changeDate()" 
                   class="border-2 border-green-100 rounded-lg p-1 text-sm focus:outline-none focus:border-green-500">
        </div>
        
        <div class="text-center">
            <p id="display-date-text" class="text-gray-500 text-sm mb-1 font-medium"></p>
            <div class="text-4xl font-black text-green-600">
                <span id="total-calories">0</span>
                <span class="text-base text-gray-400 font-normal">Ø³Ø¹Ø±Ø©</span>
            </div>
            <div class="mt-2 text-xs text-gray-400">
                Ø§Ù„Ù‡Ø¯Ù Ø§Ù„ÙŠÙˆÙ…ÙŠ: <span id="goal-display">2500</span> Ø³Ø¹Ø±Ø©
            </div>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-4 mb-6">
        <button onclick="startScanner()" class="card p-4 bg-zinc-800 text-white font-bold flex flex-col items-center hover:bg-black transition-all">
            <span class="text-2xl mb-1">ğŸ“·</span>
            <span class="text-sm">Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯</span>
        </button>
        <button onclick="showManualAdd()" class="card p-4 bg-green-500 text-white font-bold flex flex-col items-center hover:bg-green-600 transition-all">
            <span class="text-2xl mb-1">â•</span>
            <span class="text-sm">Ø¥Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠØ©</span>
        </button>
    </div>

    <div id="scanner-wrap" class="hidden mb-6 animate-pulse">
        <div class="card p-2 bg-black relative overflow-hidden">
            <div id="interactive" class="viewport"></div>
            <button onclick="stopScanner()" class="absolute top-4 left-4 bg-red-500 text-white w-8 h-8 rounded-full font-bold">X</button>
            <div class="absolute inset-0 border-2 border-green-500 m-12 rounded-lg pointer-events-none opacity-50"></div>
        </div>
    </div>

    <div class="card p-5">
        <div class="flex justify-between items-center mb-4">
            <h2 class="font-bold text-gray-700 underline decoration-green-300">Ø³Ø¬Ù„ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</h2>
            <button onclick="clearDay()" class="text-xs text-red-400 font-medium">Ù…Ø³Ø­ Ø§Ù„ÙŠÙˆÙ…</button>
        </div>
        <ul id="meals-list" class="space-y-4">
            </ul>
        <div id="empty-msg" class="text-center py-10 text-gray-300 hidden">
            Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ¬Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…
        </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-6 z-50">
        <div class="bg-white p-8 rounded-3xl w-full max-w-sm shadow-2xl">
            <h3 id="product-name" class="font-bold text-2xl mb-2 text-green-600">--</h3>
            <p class="text-gray-400 text-sm mb-6">Ø§Ù„Ø³Ø¹Ø±Ø§Øª (Ù„ÙƒÙ„ 100g): <span id="cal-per-100" class="font-bold text-gray-700">0</span></p>
            
            <label class="block mb-2 font-bold text-gray-700">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ© (ØºØ±Ø§Ù…):</label>
            <input type="number" id="amount-input" class="w-full border-2 border-gray-100 p-4 rounded-2xl mb-6 text-center text-2xl focus:border-green-500 focus:outline-none" placeholder="0">
            
            <div class="flex gap-3">
                <button onclick="addMealToLog()" class="bg-green-500 text-white flex-[2] py-4 rounded-2xl font-bold text-lg shadow-lg shadow-green-200">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ø¬Ù„</button>
                <button onclick="closeModal()" class="bg-gray-100 text-gray-500 flex-1 py-4 rounded-2xl font-medium">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <script>
        // Ù‡ÙŠÙƒÙ„ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: { "2024-05-20": [{name: "bread", totalCal: 200}, ...], ... }
        let allData = JSON.parse(localStorage.getItem('calorieTrackerData')) || {};
        let currentSelectedDate = new Date().toISOString().split('T')[0];
        let currentProduct = { name: '', calories: 0 };

        // ØªØ¹ÙŠÙŠÙ† ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… ÙÙŠ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
        document.getElementById('date-picker').value = currentSelectedDate;

        function changeDate() {
            currentSelectedDate = document.getElementById('date-picker').value;
            updateUI();
        }

        function updateUI() {
            const list = document.getElementById('meals-list');
            const totalDisplay = document.getElementById('total-calories');
            const emptyMsg = document.getElementById('empty-msg');
            const displayDate = document.getElementById('display-date-text');
            
            displayDate.innerText = new Date(currentSelectedDate).toLocaleDateString('ar-EG', { weekday: 'long', day: 'numeric', month: 'long' });
            
            list.innerHTML = '';
            let dayMeals = allData[currentSelectedDate] || [];
            let total = 0;

            if (dayMeals.length === 0) {
                emptyMsg.classList.remove('hidden');
            } else {
                emptyMsg.classList.add('hidden');
                dayMeals.forEach((meal, index) => {
                    total += meal.totalCal;
                    list.innerHTML += `
                        <li class="flex justify-between items-center p-2 border-b border-gray-50 hover:bg-gray-50 rounded-lg transition-colors">
                            <div>
                                <div class="font-bold text-gray-800 text-sm">${meal.name}</div>
                                <div class="text-[10px] text-gray-400 uppercase tracking-widest">${meal.amount} GRAMS</div>
                            </div>
                            <div class="text-left">
                                <div class="font-black text-green-600">${Math.round(meal.totalCal)}</div>
                                <button onclick="deleteMeal(${index})" class="text-[9px] text-red-300">Ø­Ø°Ù</button>
                            </div>
                        </li>`;
                });
            }
            
            totalDisplay.innerText = Math.round(total);
            // ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† Ø¥Ø°Ø§ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ (Ù…Ø«Ù„Ø§Ù‹ 2500)
            total > 2500 ? totalDisplay.classList.replace('text-green-600', 'text-red-500') : totalDisplay.classList.replace('text-red-500', 'text-green-600');
            
            localStorage.setItem('calorieTrackerData', JSON.stringify(allData));
        }

        function fetchProductInfo(code) {
            stopScanner();
            document.getElementById('product-name').innerText = "Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";
            showModal();
            
            fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`)
                .then(res => res.json())
                .then(data => {
                    if(data.status === 1) {
                        currentProduct = {
                            name: data.product.product_name || "Ù…Ù†ØªØ¬ Ø£Ù„Ù…Ø§Ù†ÙŠ",
                            calories: data.product.nutriments['energy-kcal_100g'] || 0
                        };
                        document.getElementById('product-name').innerText = currentProduct.name;
                        document.getElementById('cal-per-100').innerText = currentProduct.calories;
                    } else {
                        alert("Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø³Ø¬Ù„. Ø£Ø¶ÙÙ‡ ÙŠØ¯ÙˆÙŠØ§Ù‹.");
                        closeModal();
                    }
                }).catch(() => { alert("Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª"); closeModal(); });
        }

        function addMealToLog() {
            const amount = document.getElementById('amount-input').value;
            if(!amount) return;
            
            const totalCal = (currentProduct.calories * amount) / 100;
            
            if(!allData[currentSelectedDate]) allData[currentSelectedDate] = [];
            
            allData[currentSelectedDate].push({
                name: currentProduct.name,
                amount: amount,
                totalCal: totalCal
            });
            
            closeModal();
            updateUI();
        }

        function deleteMeal(index) {
            allData[currentSelectedDate].splice(index, 1);
            updateUI();
        }

        function clearDay() {
            if(confirm("Ù…Ø³Ø­ Ø³Ø¬Ù„ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ")) {
                allData[currentSelectedDate] = [];
                updateUI();
            }
        }

        function showManualAdd() {
            const n = prompt("Ø§Ø³Ù… Ø§Ù„Ø£ÙƒÙ„Ø©:");
            const c = prompt("Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ù„ÙƒÙ„ 100 ØºØ±Ø§Ù…:");
            if(n && c) {
                currentProduct = { name: n, calories: parseFloat(c) };
                showModal();
            }
        }

        function showModal() { document.getElementById('modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        function startScanner() {
            document.getElementById('scanner-wrap').classList.remove('hidden');
            Quagga.init({
                inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#interactive'), constraints: { facingMode: "environment" } },
                decoder: { readers: ["ean_reader"] }
            }, (err) => { if(err) return; Quagga.start(); });

            Quagga.onDetected((data) => { fetchProductInfo(data.codeResult.code); });
        }

        function stopScanner() {
            Quagga.stop();
            document.getElementById('scanner-wrap').classList.add('hidden');
        }

        // ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
        updateUI();
    </script>
</body>
</html>
